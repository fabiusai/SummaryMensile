<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Report Social - Poste Italiane</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/it.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/index.js"></script>

  <style>
    :root {
      /* Palette Istituzionale Poste Italiane */
      --brand-yellow: #eddc01;
      --brand-blue: #0146bc;
      
      /* Varianti funzionali */
      --brand-blue-hover: #003399;
      --brand-yellow-hover: #dcc800;
      
      /* Neutri e Utility */
      --white: #FFFFFF;
      --bg-light: #F4F4F4;
      --text-dark: #333333;
      --text-gray: #666666;
      --border-color: #D1D1D1;
      
      /* Feedback */
      --success: #28a745;
      --danger: #dc3545;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', 'Roboto', Helvetica, Arial, sans-serif;
      background-color: var(--bg-light);
      color: var(--text-dark);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    /* HEADER */
    .header {
      background-color: var(--brand-blue);
      color: var(--white);
      padding: 2rem 0;
      border-bottom: 6px solid var(--brand-yellow);
      margin-bottom: 2rem;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .header h1 {
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: -0.5px;
      margin-bottom: 0.5rem;
    }

    .header .subtitle {
      font-size: 1.1rem;
      font-weight: 300;
      opacity: 0.9;
    }

    /* CONTAINER PRINCIPALE */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px 60px 20px;
    }

    /* SEZIONI FORM (ACCORDION STYLE) */
    .form-section {
      background: var(--white);
      margin-bottom: 15px;
      border: 1px solid var(--border-color);
      border-radius: 4px; 
      overflow: hidden;
      transition: box-shadow 0.3s ease;
    }

    .form-section:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .section-header {
      padding: 20px 30px;
      background-color: var(--white);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid transparent;
      transition: background-color 0.2s;
    }
    
    .section-header:hover {
      background-color: #f9f9f9;
    }

    .form-section.active .section-header {
      border-bottom: 1px solid var(--border-color);
      background-color: #fcfcfc;
    }

    .section-title {
      color: var(--brand-blue);
      font-size: 1.15rem;
      font-weight: 700;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .section-title i {
      color: var(--brand-blue);
      width: 24px;
      text-align: center;
    }

    .accordion-icon {
      color: var(--text-gray);
      transition: transform 0.3s ease;
    }

    .form-section.active .accordion-icon {
      transform: rotate(180deg);
      color: var(--brand-blue);
    }

    .section-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out, padding 0.3s ease;
      padding: 0 30px;
    }

    .form-section.active .section-content {
      max-height: 2000px;
      padding: 30px;
    }

    /* GRIGLIA INPUT STANDARD */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 25px;
    }

    /* NUOVO STILE PER BEST PERFORMER (Raggruppamento Righe) */
    .performer-row {
      display: grid;
      grid-template-columns: 3fr 1fr; /* 3 parti titolo, 1 parte visualizzazioni */
      gap: 20px;
      padding: 15px;
      background-color: #fafafa;
      border: 1px solid #eee;
      border-radius: 4px;
      margin-bottom: 15px;
      align-items: end; /* Allinea label e input in basso */
    }

    .performer-number {
      font-weight: bold;
      color: var(--brand-blue);
      margin-bottom: 5px;
      display: block;
      font-size: 0.9rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 8px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px;
      font-size: 1rem;
      border: 1px solid var(--border-color);
      border-radius: 2px;
      background-color: #fff;
      color: var(--text-dark);
      transition: border-color 0.2s ease;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--brand-blue);
      background-color: #fafafa;
    }
    
    .form-group input.calcolato {
      background-color: #f0f0f0;
      color: var(--text-gray);
      border-color: #e0e0e0;
      font-weight: 500;
      cursor: not-allowed;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* CHECKBOX GROUP FOR ADV */
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 5px;
      padding: 10px;
      background: #f9f9f9;
      border: 1px solid var(--border-color);
      border-radius: 2px;
    }
    
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 0.95rem;
    }
    
    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--brand-blue);
      cursor: pointer;
    }

    /* BOTTONI ACTION - STRETTI */
    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin: 40px 0;
      padding: 20px;
      background: var(--white);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 15px;
      font-size: 0.95rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      min-width: 130px;
      border-radius: 2px;
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn-primary {
      background-color: var(--brand-blue);
      color: var(--white);
    }
    .btn-primary:hover {
      background-color: var(--brand-blue-hover);
      box-shadow: 0 2px 8px rgba(1, 70, 188, 0.3);
    }

    .btn-secondary {
      background-color: var(--brand-yellow);
      color: var(--brand-blue);
    }
    .btn-secondary:hover {
      background-color: var(--brand-yellow-hover);
    }

    .btn-success {
      background-color: #666; 
      color: var(--white);
    }
    .btn-success:hover {
      background-color: #444;
    }
    
    .btn-json {
      background-color: #28a745; 
      color: var(--white);
    }
    .btn-json:hover {
      background-color: #1e7e34;
    }

    .btn-danger {
      background-color: var(--white);
      color: var(--danger);
      border: 1px solid var(--danger);
    }
    .btn-danger:hover {
      background-color: #fff5f5;
    }

    .file-input {
      display: none;
    }

    /* PREVIEW CARDS */
    .preview-section {
      margin-top: 50px;
    }

    .preview-card {
      background: var(--white);
      border: 1px solid var(--border-color);
      margin-bottom: 30px;
      border-radius: 4px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .preview-header {
      background-color: var(--bg-light);
      padding: 15px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border-color);
    }

    .preview-header h3 {
      font-size: 1.1rem;
      color: var(--brand-blue);
      font-weight: 700;
      text-transform: uppercase;
    }

    .copy-btn {
      background-color: var(--brand-yellow);
      color: var(--brand-blue);
      border: none;
      padding: 8px 16px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      border-radius: 2px;
      transition: background-color 0.2s;
    }

    .copy-btn:hover {
      background-color: var(--brand-yellow-hover);
    }

    .preview-content {
      padding: 30px;
      font-family: 'Segoe UI', 'Roboto', Helvetica, Arial, sans-serif;
      font-size: 1.1rem;
      color: #000;
      line-height: 1.5;
    }

    .rosso {
      color: var(--danger);
      font-weight: bold;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .header {
        padding: 1.5rem 0;
      }
      .header h1 {
        font-size: 1.5rem;
      }
      .section-header {
        padding: 15px 20px;
      }
      .section-content {
        padding: 0 20px;
      }
      .form-section.active .section-content {
        padding: 20px;
      }
      .action-buttons {
        flex-direction: column;
        align-items: stretch;
      }
      .btn {
        width: 100%;
      }
      /* Responsive per Best Performer */
      .performer-row {
        grid-template-columns: 1fr;
        gap: 15px;
      }
    }
  </style>
</head>
<body>

  <header class="header">
    <div class="header-content">
      <h1>Report Social</h1>
      <div class="subtitle">Sistema di Generazione Sintesi Dati Mensili - Poste Italiane</div>
    </div>
  </header>

  <div class="container">
    
    <div class="main-content">
      
      <div class="form-section active" id="section-info">
        <div class="section-header" onclick="toggleSection('section-info')">
          <h2 class="section-title"><i class="fas fa-info-circle"></i> Informazioni Generali</h2>
          <i class="fas fa-chevron-down accordion-icon"></i>
        </div>
        <div class="section-content">
          <div class="form-grid">
            <div class="form-group">
              <label for="mese">Mese di Riferimento</label>
              <input id="mese" type="text" placeholder="Seleziona mese e anno" readonly />
            </div>
            <div class="form-group">
              <label for="iscritti">Numero Complessivo Iscritti</label>
              <input id="iscritti" type="text" placeholder="Es. 3,18M" />
            </div>
          </div>
        </div>
      </div>

      <div class="form-section" id="section-social">
        <div class="section-header" onclick="toggleSection('section-social')">
          <h2 class="section-title"><i class="fas fa-share-alt"></i> Iscritti per Piattaforma</h2>
          <i class="fas fa-chevron-down accordion-icon"></i>
        </div>
        <div class="section-content">
          <div class="form-grid">
            <div class="form-group">
              <label for="facebook"><i class="fab fa-facebook"></i> Iscritti Facebook</label>
              <input id="facebook" type="text" placeholder="Es. 1,94M" />
            </div>
            <div class="form-group">
              <label for="twitter"><i class="fab fa-twitter"></i> Iscritti X (Twitter)</label>
              <input id="twitter" type="text" placeholder="Es. 221K" />
            </div>
            <div class="form-group">
              <label for="linkedin"><i class="fab fa-linkedin"></i> Iscritti LinkedIn</label>
              <input id="linkedin" type="text" placeholder="Es. 803K" />
            </div>
            <div class="form-group">
              <label for="instagram"><i class="fab fa-instagram"></i> Iscritti Instagram</label>
              <input id="instagram" type="text" placeholder="Es. 112K" />
            </div>
            <div class="form-group">
              <label for="whatsapp"><i class="fab fa-whatsapp"></i> Iscritti Whatsapp</label>
              <input id="whatsapp" type="text" placeholder="Es. 54K" />
            </div>
            <div class="form-group">
              <label for="youtube"><i class="fab fa-youtube"></i> Iscritti YouTube</label>
              <input id="youtube" type="text" placeholder="Es. 56K" />
            </div>
          </div>
        </div>
      </div>

      <div class="form-section" id="section-content">
        <div class="section-header" onclick="toggleSection('section-content')">
          <h2 class="section-title"><i class="fas fa-edit"></i> Contenuti Pubblicati (Editoriali)</h2>
          <i class="fas fa-chevron-down accordion-icon"></i>
        </div>
        <div class="section-content">
          <div class="form-grid">
            <div class="form-group">
              <label for="totalePost">Totale Post (Calcolato)</label>
              <input id="totalePost" type="text" class="calcolato" readonly />
            </div>
            <div class="form-group">
              <label for="postEditoriali">Post Editoriali (Calcolato)</label>
              <input id="postEditoriali" type="text" class="calcolato" readonly />
            </div>
            
            <div class="form-group">
              <label for="postFacebook">Post Facebook</label>
              <input id="postFacebook" type="text" placeholder="Inserisci numero" />
            </div>
            <div class="form-group">
              <label for="postInstagram">Post Instagram</label>
              <input id="postInstagram" type="text" placeholder="Inserisci numero" />
            </div>
            <div class="form-group">
              <label for="postLinkedin">Post LinkedIn</label>
              <input id="postLinkedin" type="text" placeholder="Inserisci numero" />
            </div>
            <div class="form-group">
              <label for="tweet">Post X</label>
              <input id="tweet" type="text" placeholder="Inserisci numero" />
            </div>
            <div class="form-group">
              <label for="postWhatsapp">Post Whatsapp</label>
              <input id="postWhatsapp" type="text" placeholder="Inserisci numero" />
            </div>
            <div class="form-group">
              <label for="videoYoutube">Video YouTube</label>
              <input id="videoYoutube" type="text" placeholder="Inserisci numero" />
            </div>
          </div>
        </div>
      </div>

      <div class="form-section" id="section-best">
        <div class="section-header" onclick="toggleSection('section-best')">
          <h2 class="section-title"><i class="fas fa-trophy"></i> Best Performer</h2>
          <i class="fas fa-chevron-down accordion-icon"></i>
        </div>
        <div class="section-content">
          <div class="performer-row">
            <div class="form-group">
              <label for="titolo1">Argomento #1</label>
              <input id="titolo1" type="text" placeholder="Titolo argomento" />
            </div>
            <div class="form-group">
              <label for="vis1">Visualizzazioni</label>
              <input id="vis1" type="text" placeholder="Es. 10.000" />
            </div>
          </div>
          
          <div class="performer-row">
            <div class="form-group">
              <label for="titolo2">Argomento #2</label>
              <input id="titolo2" type="text" placeholder="Titolo argomento" />
            </div>
            <div class="form-group">
              <label for="vis2">Visualizzazioni</label>
              <input id="vis2" type="text" placeholder="Es. 8.500" />
            </div>
          </div>

          <div class="performer-row">
            <div class="form-group">
              <label for="titolo3">Argomento #3</label>
              <input id="titolo3" type="text" placeholder="Titolo argomento" />
            </div>
            <div class="form-group">
              <label for="vis3">Visualizzazioni</label>
              <input id="vis3" type="text" placeholder="Es. 5.000" />
            </div>
          </div>
        </div>
      </div>

      <div class="form-section" id="section-inst">
        <div class="section-header" onclick="toggleSection('section-inst')">
          <h2 class="section-title"><i class="fas fa-building"></i> Comunicazione Istituzionale</h2>
          <i class="fas fa-chevron-down accordion-icon"></i>
        </div>
        <div class="section-content">
          <div class="form-grid">
            <div class="form-group">
              <label for="postIstituzionali">Post Istituzionali</label>
              <input id="postIstituzionali" type="text" placeholder="Inserisci numero" />
            </div>
            <div class="form-group">
              <label for="viewsIstituzionali">Visualizzazioni</label>
              <input id="viewsIstituzionali" type="text" placeholder="Es. 150K" />
            </div>
            <div class="form-group">
              <label for="interazioniIstituzionali">Interazioni (Like/Click)</label>
              <input id="interazioniIstituzionali" type="text" placeholder="Es. 2.000" />
            </div>
          </div>
        </div>
      </div>

      <div class="form-section" id="section-atl">
        <div class="section-header" onclick="toggleSection('section-atl')">
          <h2 class="section-title"><i class="fas fa-bullhorn"></i> Campagne ATL</h2>
          <i class="fas fa-chevron-down accordion-icon"></i>
        </div>
        <div class="section-content">
          <div class="form-grid">
            
            <div class="form-group">
              <label for="campagneATL">Numero Campagne</label>
              <input id="campagneATL" type="text" placeholder="Inserisci numero" />
            </div>

            <div class="form-group">
              <label for="postADV">Post Pubblicitari (ADV)</label>
              <input id="postADV" type="text" placeholder="Inserisci numero" />
            </div>

            <div class="form-group" style="grid-column: 1 / -1;">
                <label>Seleziona Canali con attività ADV:</label>
                <div class="checkbox-group" id="advChannelsContainer">
                    <label class="checkbox-item"><input type="checkbox" value="Facebook" checked> Facebook</label>
                    <label class="checkbox-item"><input type="checkbox" value="Instagram" checked> Instagram</label>
                    <label class="checkbox-item"><input type="checkbox" value="LinkedIn"> LinkedIn</label>
                    <label class="checkbox-item"><input type="checkbox" value="X (Twitter)"> X</label>
                    <label class="checkbox-item"><input type="checkbox" value="TikTok"> TikTok</label>
                    <label class="checkbox-item"><input type="checkbox" value="YouTube"> YouTube</label>
                    <label class="checkbox-item"><input type="checkbox" value="Whatsapp"> Whatsapp</label>
                </div>
            </div>

            <div class="form-group" style="grid-column: 1 / -1;">
              <label for="elencoCampagne">Elenco Campagne</label>
              <textarea id="elencoCampagne" rows="3" placeholder="Es. Campagna Inverno, Offerta Giovani..."></textarea>
            </div>
            <div class="form-group">
              <label for="viewsATL">Impression</label>
              <input id="viewsATL" type="text" placeholder="Es. 1M" />
            </div>
            <div class="form-group">
              <label for="utentiATL">Utenti Unici</label>
              <input id="utentiATL" type="text" placeholder="Es. 500K" />
            </div>
            <div class="form-group">
              <label for="clickATL">Link Click</label>
              <input id="clickATL" type="text" placeholder="Es. 10K" />
            </div>
            <div class="form-group">
              <label for="interazioniATL">Interazioni Totali</label>
              <input id="interazioniATL" type="text" placeholder="Es. 15K" />
            </div>
          </div>
        </div>
      </div>

      <div class="form-section" id="section-eng">
        <div class="section-header" onclick="toggleSection('section-eng')">
          <h2 class="section-title"><i class="fas fa-comments"></i> Engagement</h2>
          <i class="fas fa-chevron-down accordion-icon"></i>
        </div>
        <div class="section-content">
          <div class="form-grid">
            <div class="form-group">
              <label for="commenti">Commenti Totali</label>
              <input id="commenti" type="text" placeholder="Inserisci numero" />
            </div>
            <div class="form-group">
              <label for="tendenzaCommenti">Trend Commenti</label>
              <input id="tendenzaCommenti" type="text" placeholder="Es. aumento/diminuzione" />
            </div>
            <div class="form-group">
              <label for="argomentiFacebook">Topic Prevalenti (FB)</label>
              <input id="argomentiFacebook" type="text" placeholder="Es. Servizio Clienti, App..." />
            </div>
            <div class="form-group">
              <label for="prevalenzaCommenti">Percentuale Topic</label>
              <input id="prevalenzaCommenti" type="text" placeholder="Es. 40%" />
            </div>
          </div>
        </div>
      </div>

      <div class="action-buttons">
        <button id="btnGenera" class="btn btn-primary" onclick="generaAnteprima(this)">
          <i class="fas fa-cogs"></i> Genera Report
        </button>
        <button id="btnSalva" class="btn btn-secondary" onclick="salvaDati(this)">
            <i class="fas fa-save"></i> Salva Dati
        </button>
        <button class="btn btn-success" onclick="exportExcel(event)">
          <i class="fas fa-file-excel"></i> Esporta Excel
        </button>
        <button class="btn btn-success" onclick="document.getElementById('fileImport').click()">
          <i class="fas fa-upload"></i> Importa Excel
        </button>
        <button class="btn btn-json" onclick="document.getElementById('jsonImport').click()">
          <i class="fas fa-file-code"></i> Importa JSON
        </button>
        <button class="btn btn-danger" onclick="cancellaTutto(this)">
          <i class="fas fa-trash"></i> Reset
        </button>
        
        <input type="file" id="fileImport" class="file-input" onchange="importExcel(event)" accept=".xlsx, .xls" />
        <input type="file" id="jsonImport" class="file-input" onchange="importJson(event)" accept=".json" multiple />
      </div>

      <div class="preview-section" id="preview">
        <div class="preview-card" id="sectionPPT1">
          <div class="preview-header">
            <h3>PPT 1 (Sintesi)</h3>
            <button class="copy-btn" onclick="copyHtmlContent(this, 'textPPT1')">
              <i class="fas fa-copy"></i> Copia
            </button>
          </div>
          <div id="textPPT1" class="preview-content"></div>
        </div>

        <div class="preview-card" id="sectionPPT2">
          <div class="preview-header">
            <h3>PPT 2 (Presentazione Staff Meeting)</h3>
            <button class="copy-btn" onclick="copyHtmlContent(this, 'textPPT2')">
              <i class="fas fa-copy"></i> Copia
            </button>
          </div>
          <div id="textPPT2" class="preview-content"></div>
        </div>

        <div class="preview-card" id="sectionEsteso">
          <div class="preview-header">
            <h3>Report Esteso</h3>
            <button class="copy-btn" onclick="copyHtmlContent(this, 'textEsteso')">
              <i class="fas fa-copy"></i> Copia
            </button>
          </div>
          <div id="textEsteso" class="preview-content"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Calcolo data del mese precedente per il default
    const today = new Date();
    // Imposta al primo giorno del mese precedente per evitare bug con giorni come il 31
    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);

    // Inizializzazione di Flatpickr
    flatpickr("#mese", {
      plugins: [
        new monthSelectPlugin({
          shorthand: false,
          dateFormat: "F Y",
          altFormat: "F Y"
        })
      ],
      locale: "it",
      defaultDate: lastMonth // Imposta di default il mese precedente
    });
    
    document.addEventListener('DOMContentLoaded', function() {
      caricaDatiSalvati();

      const calculationInputs = [
        'postADV', 'postFacebook', 'postInstagram', 'postLinkedin', 
        'tweet', 'postWhatsapp', 'videoYoutube'
      ];

      calculationInputs.forEach(id => {
        const inputElement = document.getElementById(id);
        if (inputElement) {
          inputElement.addEventListener('input', calcolaTotali);
        }
      });
      
      calcolaTotali();
    });

    // Funzione Accordion
    function toggleSection(id) {
        const section = document.getElementById(id);
        section.classList.toggle('active');
    }

    function get(id) {
      const el = document.getElementById(id);
      return el ? el.value || "<span class='rosso'>XXX</span>" : "XXX";
    }
    
    // Funzione per recuperare i canali ADV selezionati
    function getSelectedAdvChannels() {
        const checkboxes = document.querySelectorAll('#advChannelsContainer input[type="checkbox"]:checked');
        if (checkboxes.length === 0) return "<span class='rosso'>NESSUN CANALE SELEZIONATO</span>";
        
        const values = Array.from(checkboxes).map(cb => cb.value);
        
        if (values.length === 1) return values[0];
        
        const last = values.pop();
        return values.join(", ") + " e " + last;
    }

    function calcolaTotali() {
      const postFacebook = parseFloat(document.getElementById('postFacebook').value) || 0;
      const postInstagram = parseFloat(document.getElementById('postInstagram').value) || 0;
      const postLinkedin = parseFloat(document.getElementById('postLinkedin').value) || 0;
      const postX = parseFloat(document.getElementById('tweet').value) || 0;
      const postWhatsapp = parseFloat(document.getElementById('postWhatsapp').value) || 0;
      const videoYoutube = parseFloat(document.getElementById('videoYoutube').value) || 0;
      const postADV = parseFloat(document.getElementById('postADV').value) || 0;
      
      const postEditoriali = postFacebook + postInstagram + postLinkedin + postX + postWhatsapp + videoYoutube;
      const totalePost = postEditoriali + postADV;
      
      document.getElementById('postEditoriali').value = postEditoriali;
      document.getElementById('totalePost').value = totalePost;
    }

    function generaAnteprima(btn) {
      const original = btn.innerHTML;
      btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Elaborazione...";
      btn.disabled = true;

      setTimeout(() => {
        const meseFormattato = get("mese") || "<span class='rosso'>XXX</span>";
        const canaliADV = getSelectedAdvChannels();

        const ppt1 = "<b>Emesso il Report social di " + meseFormattato + "</b>: " +
                     get("iscritti") + " iscritti totali; " +
                     get("totalePost") + " post pubblicati di cui " +
                     get("postIstituzionali") + " su temi istituzionali; " +
                     get("campagneATL") + " campagne ATL; " +
                     get("commenti") + " commenti.";
        
        // Ordine fisso dei canali richiesto
        const platforms = [
          { name: 'Facebook', id: 'facebook' },
          { name: 'Instagram', id: 'instagram' },
          { name: 'Linkedin', id: 'linkedin' },
          { name: 'X', id: 'twitter' },
          { name: 'Whatsapp', id: 'whatsapp' },
          { name: 'YouTube', id: 'youtube' }
        ];

        // Creazione stringa ordinata (senza sorting per valore)
        const iscrittiOrdinatiString = platforms
          .map(p => {
             const val = get(p.id);
             const numVal = parseInt(val.replace(/\D/g,'')) || 0;
             return { name: p.name, val: val, num: numVal };
          })
          .filter(p => p.num > 0) 
          .map(p => `${p.name} ${p.val}`)
          .join(', ');

        const ppt2 = "Il numero complessivo degli iscritti è pari a " + get("iscritti") +
                     ": " + iscrittiOrdinatiString + ".<br><br>" +
                     "Durante il mese abbiamo pubblicato " + get("totalePost") +
                     " post (" + get("postEditoriali") + " editoriali e " + get("postADV") +
                     " sponsorizzati): " + get("postFacebook") + " post Facebook, " +
                     get("postInstagram") + " post Instagram, " +
                     get("postLinkedin") + " post Linkedin, " +
                     get("tweet") + " post X, " +
                     get("postWhatsapp") + " post Whatsapp, " +
                     get("videoYoutube") + " video YouTube, " +
                     get("postADV") + " post relativi alle campagne ADV (" + canaliADV + ").<br><br>" +
                     "I contenuti editoriali più visualizzati sono stati i post dedicati a: " +
                     get("titolo1") + " (" + get("vis1") + " Visualizzazioni); " +
                     get("titolo2") + " (" + get("vis2") + " Visualizzazioni); " +
                     get("titolo3") + " (" + get("vis3") + " Visualizzazioni).<br><br>" +
                     "Sono stati pubblicati " + get("postIstituzionali") +
                     " post a contenuto «istituzionale» che hanno generato " +
                     get("viewsIstituzionali") + " visualizzazioni e " +
                     get("interazioniIstituzionali") + " like e interazioni.<br><br>" +
                     "Nel corso del mese sono state gestite " + get("campagneATL") +
                     " campagne ATL che hanno sviluppato complessivamente " +
                     get("viewsATL") + " impression, raggiunto " +
                     get("utentiATL") + " utenti unici e generato un engagement per " +
                     get("clickATL") + " link click e " +
                     get("interazioniATL") + " interazioni.<br><br>" +
                     "Nel mese gli utenti hanno pubblicato " + get("commenti") +
                     " commenti ai post. I commenti hanno riguardato, in prevalenza, il tema “" +
                     get("argomentiFacebook") + "” (" +
                     get("prevalenzaCommenti") + ").";

        const esteso = "Report social del mese di <b>" + meseFormattato + "</b>.<br><br>" +
                       "Il numero complessivo degli <b>iscritti</b> è pari a <b>" + get("iscritti") + "</b>.<br><br>" +
                       "I fan <b>Facebook</b> (Poste Italiane, PosteMobile, Postepay) sono <b>" + get("facebook") + "</b>, mentre su <b>X</b> il numero di followers ammonta a <b>" + get("twitter") + "</b>. Su <b>Linkedin</b> sono <b>" + get("linkedin") + "</b>, su <b>Instagram</b> <b>" + get("instagram") + "</b>, su <b>Whatsapp</b> <b>" + get("whatsapp") + "</b> e su <b>YouTube</b> <b>" + get("youtube") + "</b>.<br><br>" +
                       "Durante il mese abbiamo pubblicato <b>" + get("totalePost") + " post</b> (<b>" + get("postEditoriali") + " editoriali</b> e <b>" + get("postADV") + " sponsorizzati</b>):<br>" +
                       "• " + get("postFacebook") + " post Facebook<br>" +
                       "• " + get("postInstagram") + " post Instagram<br>" +
                       "• " + get("postLinkedin") + " post LinkedIn<br>" +
                       "• " + get("tweet") + " post X<br>" +
                       "• " + get("postWhatsapp") + " post Whatsapp<br>" +
                       "• " + get("videoYoutube") + " video YouTube<br>" +
                       "• " + get("postADV") + " post relativi alle campagne ADV (" + canaliADV + ")<br><br>" +
                       "<b>I contenuti editoriali più visualizzati</b> sono stati:<br>" +
                       "• <b>" + get("titolo1") + "</b> (" + get("vis1") + " Visualizzazioni)<br>" +
                       "• <b>" + get("titolo2") + "</b> (" + get("vis2") + " Visualizzazioni)<br>" +
                       "• <b>" + get("titolo3") + "</b> (" + get("vis3") + " Visualizzazioni)<br><br>" +
                       "L’attività di <b>comunicazione istituzionale</b> ha portato alla pubblicazione di <b>" + get("postIstituzionali") + " post</b> che hanno generato <b>" + get("viewsIstituzionali") + " visualizzazioni</b> e <b>" + get("interazioniIstituzionali") + " like e interazioni</b>.<br><br>" +
                       "Sono state gestite <b>" + get("campagneATL") + " campagne ATL</b> (" + canaliADV + "): <b>" + get("elencoCampagne") + "</b>.<br><br>" +
                       "Le campagne hanno sviluppato complessivamente:<br>" +
                       "• <b>" + get("viewsATL") + " impression</b><br>" +
                       "• <b>" + get("utentiATL") + " utenti unici</b><br>" +
                       "e generato engagement per <b>" + get("clickATL") + " link click</b> e <b>" + get("interazioniATL") + " interazioni</b>.<br><br>" +
                       "Nel mese si registrano <b>" + get("commenti") + " commenti</b> pubblici sui canali, in " + get("tendenzaCommenti") + " rispetto al mese precedente. I commenti sulla pagina Facebook di Poste Italiane hanno riguardato in prevalenza il tema <b>“" + get("argomentiFacebook") + "”</b> (" + get("prevalenzaCommenti") + ").";

        document.getElementById("textPPT1").innerHTML = ppt1;
        document.getElementById("textPPT2").innerHTML = ppt2;
        document.getElementById("textEsteso").innerHTML = esteso;
        
        btn.innerHTML = "<i class='fas fa-check'></i> Report Generato!";
        document.getElementById('preview').scrollIntoView({behavior: 'smooth'});
        
        setTimeout(() => {
             btn.innerHTML = original;
             btn.disabled = false;
        }, 2000);
      }, 500);
    }
    
    function salvaDati(btn) {
      const original = btn.innerHTML;
      btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Salvataggio...";
      btn.disabled = true;

      setTimeout(() => {
        // Salvataggio Input Testuali
        const fields = document.querySelectorAll("input[type='text'], textarea");
        fields.forEach(f => {
            if (f.id) localStorage.setItem(f.id, f.value);
        });

        // Salvataggio Checkbox ADV
        const advCheckboxes = document.querySelectorAll('#advChannelsContainer input[type="checkbox"]');
        const advState = {};
        advCheckboxes.forEach(cb => {
            advState[cb.value] = cb.checked;
        });
        localStorage.setItem('advChannels', JSON.stringify(advState));

        btn.innerHTML = "<i class='fas fa-check'></i> Dati Salvati!";
        setTimeout(() => {
            btn.innerHTML = original;
            btn.disabled = false;
        }, 1500);
      }, 500);
    }

    function caricaDatiSalvati() {
        const fields = document.querySelectorAll("input[type='text'], textarea");
        fields.forEach(f => {
            if (f.id) {
                const savedValue = localStorage.getItem(f.id);
                if (savedValue !== null) f.value = savedValue;
            }
        });

        const savedAdv = localStorage.getItem('advChannels');
        if (savedAdv) {
            const advState = JSON.parse(savedAdv);
            const checkboxes = document.querySelectorAll('#advChannelsContainer input[type="checkbox"]');
            checkboxes.forEach(cb => {
                if (advState.hasOwnProperty(cb.value)) {
                    cb.checked = advState[cb.value];
                }
            });
        }
    }

    function copyHtmlContent(btn, id) {
      const content = document.getElementById(id);
      const range = document.createRange();
      range.selectNodeContents(content);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
      document.execCommand("copy"); 
      sel.removeAllRanges();

      const original = btn.innerHTML;
      btn.innerHTML = "<i class='fas fa-check'></i> Copiato!";
      setTimeout(() => {
        btn.innerHTML = original;
      }, 1500);
    }

    function cancellaTutto(btn) {
      const original = btn.innerHTML;
      btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Pulizia...";
      btn.disabled = true;

      if (confirm("Confermi la cancellazione di tutti i campi?")) {
        setTimeout(() => {
          const fields = document.querySelectorAll("input, textarea");
          fields.forEach(f => {
             if(f.type !== 'checkbox' && f.type !== 'file') f.value = "";
          });
          
          fields.forEach(f => { if(f.id) localStorage.removeItem(f.id); });
          localStorage.removeItem('advChannels');

          document.getElementById("textPPT1").innerHTML = "";
          document.getElementById("textPPT2").innerHTML = "";
          document.getElementById("textEsteso").innerHTML = "";
          
          btn.innerHTML = "<i class='fas fa-check'></i> Cancellato!";
          setTimeout(() => {
            btn.innerHTML = original;
            btn.disabled = false;
          }, 1500);
        }, 500);
      } else {
        btn.innerHTML = original;
        btn.disabled = false;
      }
    }

    function exportExcel(event) {
      event.preventDefault();
      const btn = event.target;
      const original = btn.innerHTML;
      btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Export...";
      btn.disabled = true;

      try {
        const data = [];
        const headers = ["Campo", "Valore"];
        data.push(headers);
        
        const fields = document.querySelectorAll("input[type='text'], textarea");
        fields.forEach(field => {
          if (field.id) data.push([field.id, field.value]);
        });
        
        const canaliADV = getSelectedAdvChannels();
        data.push(["canaliADV", canaliADV]);

        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Dati Report");
        const wbout = XLSX.write(wb, {bookType:'xlsx', type:'binary'});
        
        function s2ab(s) {
          const buf = new ArrayBuffer(s.length);
          const view = new Uint8Array(buf);
          for (let i=0; i<s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
          return buf;
        }
        
        const mese = document.getElementById('mese').value || 'report';
        const filename = `Report_Social_${mese.replace(/\s+/g, '_')}.xlsx`;
        
        saveAs(new Blob([s2ab(wbout)], {type:"application/octet-stream"}), filename);
        
        btn.innerHTML = "<i class='fas fa-check'></i> Fatto!";
        setTimeout(() => {
          btn.innerHTML = original;
          btn.disabled = false;
        }, 1500);
      } catch (error) {
        console.error("Errore:", error);
        alert("Errore export.");
        btn.innerHTML = original;
        btn.disabled = false;
      }
    }

    function importExcel(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const buttons = document.querySelectorAll('.btn');
      let importBtn;
      buttons.forEach(b => { if(b.textContent.includes('Importa Excel')) importBtn = b; });
      
      const original = importBtn ? importBtn.innerHTML : "Importa";
      if(importBtn) {
         importBtn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Caricamento...";
         importBtn.disabled = true;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          const worksheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
          
          jsonData.shift();
          
          jsonData.forEach(row => {
            if (row.length >= 2) {
              const fieldId = row[0];
              const value = row[1];
              
              if(fieldId !== 'canaliADV') {
                  const field = document.getElementById(fieldId);
                  if (field) field.value = value;
              }
            }
          });
          
          calcolaTotali();
          
          if(importBtn) {
            importBtn.innerHTML = "<i class='fas fa-check'></i> Completato!";
            setTimeout(() => {
                importBtn.innerHTML = original;
                importBtn.disabled = false;
            }, 1500);
          }
        } catch (error) {
          console.error("Errore import Excel:", error);
          alert("Errore durante l'importazione del file Excel.");
          if(importBtn) {
            importBtn.innerHTML = original;
            importBtn.disabled = false;
          }
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // Importazione JSON (MULTI-FILE)
    function importJson(event) {
      // Usa .files per prendere tutti i file selezionati
      const files = event.target.files;
      if (files.length === 0) return;

      const buttons = document.querySelectorAll('.btn');
      let importBtn;
      buttons.forEach(b => { if(b.textContent.includes('Importa JSON')) importBtn = b; });

      const original = importBtn ? importBtn.innerHTML : "Importa JSON";
      if(importBtn) {
         importBtn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Caricamento...";
         importBtn.disabled = true;
      }

      // Dizionario di Mappatura aggiornato con ENGAGEMENT
      const jsonMapping = {
        // --- SEZIONE ISCRITTI (ES1.json) ---
        "Numero Complessivo Iscritti": "iscritti",
        "Iscritti Facebook": "facebook",
        "Iscritti X (Twitter)": "twitter",
        "Iscritti Linkedin": "linkedin",
        "Iscritti Instagram": "instagram",
        "Iscritti Whatsapp": "whatsapp",
        "Iscritti YouTube": "youtube",
        
        // --- SEZIONE POST E CONTENUTI (ES2.json) ---
        "Numero post Facebook": "postFacebook",
        "Numero post X (Twitter)": "tweet",
        "Numero post Linkedin": "postLinkedin",
        "Numero post Instagram": "postInstagram",
        "Numero post Youtube": "videoYoutube",
        "Numero post Whatsapp": "postWhatsapp",
        
        // Best Performer
        "Argomenti più visualizzati 1": "titolo1",
        "Visualizzazione Argomenti più visualizzati 1": "vis1",
        "Argomenti più visualizzati 2": "titolo2",
        "Visualizzazione Argomenti più visualizzati 2": "vis2",
        "Argomenti più visualizzati 3": "titolo3",
        "Visualizzazione Argomenti più visualizzati 3": "vis3",
        
        // Comunicazione Istituzionale
        "Numero post istituzionali": "postIstituzionali",
        "Visualizzazione post istituzionali": "viewsIstituzionali",
        "Like + interazioni post istituzionali": "interazioniIstituzionali",

        // --- SEZIONE ENGAGEMENT (ES3.json) ---
        "Totale commenti": "commenti",
        "Variazione commenti rispetto al mese precedente": "tendenzaCommenti",
        "Dettaglio Argomenti: Temi trattati Poste Italiane FB: l'argomento con più commenti": "argomentiFacebook",
        "Dettaglio Argomenti: valore in percentuale commenti argomento Temi trattati Poste Italiane FB": "prevalenzaCommenti"
      };

      let filesProcessed = 0;
      let totalFieldsUpdated = 0;

      // Cicla attraverso tutti i file selezionati
      Array.from(files).forEach(file => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
          try {
            const jsonData = JSON.parse(e.target.result);
            
            for (const [key, value] of Object.entries(jsonData)) {
              if (jsonMapping[key]) {
                 const targetId = jsonMapping[key];
                 const inputElement = document.getElementById(targetId);
                 
                 if (inputElement) {
                   inputElement.value = value;
                   totalFieldsUpdated++;
                 }
              }
            }
          } catch (error) {
            console.error(`Errore importazione file ${file.name}:`, error);
          } finally {
            filesProcessed++;
            // Se abbiamo finito di leggere tutti i file
            if (filesProcessed === files.length) {
                calcolaTotali();
                
                if(importBtn) {
                  importBtn.innerHTML = "<i class='fas fa-check'></i> " + totalFieldsUpdated + " Campi!";
                  setTimeout(() => {
                      importBtn.innerHTML = original;
                      importBtn.disabled = false;
                  }, 2000);
                }
                // Reset input
                event.target.value = '';
            }
          }
        };
        
        reader.readAsText(file);
      });
    }
  </script>
</body>
</html>
